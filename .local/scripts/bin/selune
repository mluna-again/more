#! /usr/bin/env bash

SCRIPT_NAME=selune.sh
SCRIPT_PATH="$PWD/$SCRIPT_NAME"
FUNC_REGEX='[a-zA-Z]+[a-zA-Z0-9_-]*\(\)'

selune_exists() {
  [ -f "$SCRIPT_PATH" ]
}

stderr() {
  echo "$*" 1>&2
}

if ! selune_exists; then
  stderr "$SCRIPT_NAME not found / not executable."
  exit 0
fi

selune_functions=$(grep --extended-regexp "$FUNC_REGEX" "$SCRIPT_PATH" | sed -e 's|()||g' -e 's|\s*{\s*||' -e 's|#\s*|#|' | awk -F'#' '{if ($2 != "") { printf "%s\t\t\t# %s\n", $1, $2} else {print $1}}')
if [ -z "$selune_functions" ]; then
  stderr "No functions found in $SCRIPT_NAME. Regex: $FUNC_REGEX"
  exit 0
fi

query=""
if [ -n "$1" ]; then
  query="-1 -q $1"
  shift
fi

export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS --height=10"
source "$SCRIPT_PATH" || exit

title="${SELUNE_TITLE:-Run a function}"
func=$(echo "$selune_functions" | fzf $query --height=10 --nth=1 --ghost="$title" | awk -F'#' '{gsub(/[ \t]*/, "", $1); print $1}') || exit
[ -z "$func" ] && exit 1

"$func" "$@"
