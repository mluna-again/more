#! /usr/bin/env bash

installed() {
	if ! command -v "$1" &>/dev/null; then
		echo "$2" >&2
		exit 1
	fi
}

installed hurl "Missing dependency: hurl"
installed jnv "Missing dependency: jnv"
installed fzf "Missing dependency: fzf"

isdarwin() {
	uname | grep -i darwin
}

date="date"
if isdarwin; then
	date=gdate
fi

if ! command -v "$date" &>/dev/null; then
	echo "Please install gnu date" >&2
	exit 1
fi

q="$@"
if [ "$#" -eq 1 ] && [ -f "$1" ]; then
  FILE="$1"
else
  FILE="$(find . -iname '*.hurl' | fzf -q "$q" -1)"
fi

if [ ! -f "$FILE" ]; then
	echo "Could not open file." >&2
	exit 1
fi

DATE_FMT="+%Y-%m-%dT%H:%M:%S%z"
NOW=$("$date" -u "$DATE_FMT")

HURL_KOI_NOW=$("$date" -u -d "$NOW" "$DATE_FMT") || exit
HURL_KOI_YESTERDAY=$("$date" -u -d "$NOW -1 days" "$DATE_FMT") || exit
HURL_KOI_TOMORROW=$("$date" -u -d "$NOW +1 days" "$DATE_FMT") || exit
HURL_KOI_TODAY=$("$date" -u -d "$NOW" "$DATE_FMT") || exit
HURL_KOI_UUID=$(uuidgen) || exit
HURL_KOI_RANDOM=$RANDOM
HURL_KOI_LOREM="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."
export HURL_KOI_YESTERDAY
export HURL_KOI_NOW
export HURL_KOI_TOMORROW
export HURL_KOI_TODAY
export HURL_KOI_UUID
export HURL_KOI_RANDOM
export HURL_KOI_LOREM

output=$(hurl --include "$FILE") || exit

if grep -iq "content-type: application/json" <<< "$output"; then
  echo "$output" | awk 'headers_end{print} /^\s*$/{headers_end=1}' | jnv
  echo
  echo
  echo -e "$output"
else
  ft="set ft=http"
  grep -i "content-type: text/html" <<< "$output" && ft="set ft=html"

  echo "$output" | nvim -c 'set cmdheight=1' -c 'set buftype=nofile' -c "$ft"
fi
