#! /usr/bin/env bash

# vim:set filetype=sh:

usage() {
  cat << EOF
Synopsis:
  xdo [options] <cmd>

Description:
  Reads every line of STDIN and runs <cmd> doing param substitution in a new TMUX pane.

Options:
  -s <shell> | --shell <shell>    shell command. SEE NOTES. (default: fish -C <cmd>)
  -F <sep> | --sep <sep>          line separator (default: " ")
  -P | --private                  use fish's private mode. this overrides --shell (default: no)
  -x | --killp                    kill original pane after running all commands (default: no)
  -l <name> | --layout <name>     tmux layout (default: tiled)
  -y | --yes                      don't ask for confirmation (default: no)
  -h | --help                     show this message
All options should be at the beginning, and the <cmd> starts after the first non-recognized option.

Usage:
  $ cat urls.txt
  https://...
  https://...
  https://...
  $ cat urls.txt | xdo ping {} # creates 3 panes running ping

  $ cat urls_with_names.txt
  file1 https://...
  file2 https://...
  file3 https://...
  $ cat urls.txt | xdo curl {2} -o {1} # using line elements separately

Special notes:
  * If you want to use bash, you can't just do 'xdo -s bash ...', you need 'xdo -s "bash -c" ...'
  * If you are using bash, and remain-on-exit is off, if you just do 'xdo -s "bash -c" ...' all panes will close as soon as the command is done running (no matter the exit code).
  You probably don't want this (that's why fish -C is the default, it doesn't have this problem). You can do something like this 'xdo -s "bash -c" <command> \; bash'
  * Honestly just don't use the --shell option, use something like 'xdo "bash -c ..."' instead, or run your command in a script with a shebang ¯\_(ツ)_/¯.
  * Should I remove the --shell option? I think it is still useful to know the default value is 'fish -C'... I'll leave it.

You need to run this script inside TMUX.
EOF
  exit 1
}

[ -z "$TMUX" ] && usage
[ -z "$*" ] && usage

valid_layout() {
  [ even-horizontal = "$1" ] || \
  [ even-vertical = "$1" ] || \
  [ main-horizontal = "$1" ] || \
  [ main-horizontal-mirrored = "$1" ] || \
  [ main-vertical = "$1" ] || \
  [ main-vertical-mirrored = "$1" ] || \
  [ tiled = "$1" ]
}

separator=" "
shell="fish -C"
private=0
kill_pane=0
skip_confirmation=0
layout=tiled
while true; do
  [ -z "$1" ] && break

  case "$1" in
    -y|--yes)
      skip_confirmation=1
      ;;

    -s|--shell)
      shift
      shell="$1"
      ;;

    -l|--layout)
      shift
      layout="$1"
      if ! valid_layout "$layout"; then
        echo Invalid layout >&2
        exit 1
      fi
      ;;

    -P|--private)
      private=1
      ;;

    -x|--killp)
      kill_pane=1
      ;;

    -F|--sep)
      shift
      separator="$1"
      ;;

    --help|-h|help)
      usage
      ;;

    *)
      break
      ;;
  esac

  shift
done
command="$*"

commands=()
warnings=()

while read -r line; do
  if grep -q '^\s*$' <<< "$line"; then
    continue
  fi

  fields_num=$(awk -F"$separator" '{print NF}' <<< "$line") || exit
  _command="$command"
  index=0
  for (( i=0 ; i < fields_num ; i++ )); do
    index=$(( index + 1 ))
    value=$(awk -F"$separator" "{print \$$index}" <<< "$line") || exit
    _command=$(sed "s|{$index}|$value|g" <<< "$_command") || exit
  done
  _command=$(sed "s|{}|$line|g" <<< "$_command") || exit

  commands+=("$_command")
  if grep -q '{[0-9]*}' <<< "$_command"; then
    warnings+=("$_command has placeholders without a value")
  fi
done

if [ "${#commands[@]}" -lt 1 ]; then
  echo No lines read. >&2
  exit 1
fi

for cmd in "${commands[@]}"; do
  echo "$cmd"
done

[ -n "${warnings[*]}" ] && echo
for warning in "${warnings[@]}"; do
  echo "[WARNING] $warning" >&2
done

if [ "$skip_confirmation" -eq 0 ]; then
  echo
  printf "Continue? [N/y] "
  read -r response < /dev/tty
  if [ "${response,,}" != y ]; then
    exit 1
  fi
fi

original_pane=$(tmux display -p '#{pane_id}') || exit
for cmd in "${commands[@]}"; do
  if [ "$private" -eq 1 ]; then
    tmux split-window -c '#{pane_current_path}' fish -P -C "$cmd"
  else
    # shellcheck disable=SC2086
    tmux split-window -c '#{pane_current_path}' $shell "$cmd"
  fi
  tmux select-layout "$layout"
done

if [ "$kill_pane" -eq 1 ]; then
  tmux kill-pane -t "$original_pane" \; select-layout "$layout"
else
  tmux select-pane -t "$original_pane" \; select-layout "$layout"
fi
